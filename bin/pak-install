#!/usr/bin/env -S Rscript --vanilla 

# This script is meant to be called ./configure, so I don't assume {scribe} is available

if (!requireNamespace("scribe", quietly = TRUE)) {
  message("w {scribe} not found")
  message("i installing {scribe}")
  utils::install.packages("scribe", repos = c(CRAN = "https://cran.rstudio.com/"))
  stop("q please run pak-install again")
}

options(pak.no_extra_messages = TRUE)

library(scribe)
ca <- command_args()
ca$add_argument(
  "...",
  "source",
  action = "dots",
  default = "cran",
  options = list(choices = c("cran", "source")),
  info = "Source to install"
)$add_argument(
  "--pkg-type",
  default = .Platform$pkgType
)$add_argument(
  "--os",
  default = R.Version()$os,
  info = "operating system"
)$add_argument(
  "--arch",
  default = R.Version()$arch
)$add_argument(
  "-d",
  "--dependencies",
  default = NA
)$add_argument(
  "-r",
  "--reinstall",
  default = FALSE,
  info = "pak pak pak"
)$add_argument(
  "--extra-messages",
  action = "flag",
  default = TRUE,
  info = "show extra pak messages"
)

args <- ca$parse()

switch(
  args$source,
  cran = {
    repo <- c(CRAN = "https://cran.rstudio.com/")
    text <- "CRAN"
  },
  source = {
    repo <- sprintf(
      "https://r-lib.github.io/p/pak/stable/%s/%s/%s",
      args$pkg_type,
      args$os,
      args$arch
    )
    text <- "pre-built binary"
  }
)


if (args$reinstall) {
  message("i reinstalling {pak} ", text)
  pak::pak("pak?reinstall", dependencies = args$dependencies)
} else {
  message("i installing {pak} ", text)
  # https://github.com/r-lib/pak#pre-built-binaries
  utils::install.packages("pak", repos = repo, dependencies = args$dependencies)
}

message("i installing {pak} extra")
pak::pak_install_extra()

message("i done")
invisible()
