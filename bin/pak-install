#!/usr/bin/env -S Rscript --vanilla 

# This script is meant to be called ./configure, so I don't assume {scribe} is available

options(pak.no_extra_messages = TRUE)

msg <- function(...) message("[msg] ", ...)

library(scribe)
ca <- command_args()
ca$add_argument(
  "...",
  "source",
  action = "dots",
  default = "cran",
  options = list(choices = c("cran", "source")),
  info = "Source to install"
)
ca$add_argument(
  "--pkg-type",
  default = .Platform$pkgType
)
ca$add_argument(
  "--os",
  default = R.Version()$os,
  info = "operating system"
)
ca$add_argument(
  "--arch",
  default = R.Version()$arch
)
ca$add_argument(
  "-d",
  "--dependencies",
  default = NA
)
ca$add_argument(
  "-r",
  "--reinstall",
  default = FALSE,
  info = "pak pak pak"
)

args <- ca$parse()

switch(
  args$source,
  cran = {
    repo <- c(CRAN = "https://cran.rstudio.com/")
    text <- "CRAN"
  },
  source = {
    repo <- sprintf(
      "https://r-lib.github.io/p/pak/stable/%s/%s/%s",
      args$pkg_type,
      args$os,
      args$arch
    )
    text <- "pre-built binary"
  }
)

msg("Installing {pak} ", text)
# https://github.com/r-lib/pak#pre-built-binaries
utils::install.packages("pak", repos = repo, dependencies = args$dependencies)

if (args$reinstall) {
  pak::pak("pak", dependencies = args$dependencies)
}

msg("done")
