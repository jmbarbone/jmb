#!/usr/bin/env -S Rscript --vanilla 


# pak for pak
options(
  repos =  c(CRAN = "https://cloud.r-project.org"),
  pak.no_extra_messages = TRUE
)

library(scribe)
ca <- command_args()
ca$add_description("pak : R package installation")
ca$add_description("console wrapper for calling pak::pak() from R.")
ca$add_example("pak fuj", "install {fuj} from CRAN")
ca$add_example("pak --d true -u github::tidyverse/dplyr github::tidyverse/tidyr", "install dev packages")
ca$add_argument(
  "...",
  "pkg",
  default = "local::.",
  info = "packages to install (default: local::.)"
)
ca$add_argument(
  "-d",
  "--dep",
  "--dependencies",
  default = NA,
  info = "dependencies (coerced)"
)
ca$add_argument(
  "--upgrade",
  action = "flag",
  default = FALSE,
  info = "use most recent version of packages"
)
ca$add_argument(
  "-u",
  "--update",
  action = "flag",
  default = TRUE,
  info = "install new versions of packages"
)
ca$add_argument(
  "--sysreqs",
  action = "flag",
  default = FALSE,
  info = "Tries to install system requirements"
)
ca$add_argument(
  "-e",
  "--echo",
  action = "flag",
  default = FALSE,
  info = "Echo the lock file"
)

ca$add_argument(
  "--lib",
  action = "list",
  default = .libPaths()[1],
  info = c(
    "library location for plan and installation"
  )
)
ca$add_argument(
  "--lib-create",
  action = "list",
  default = NULL,
  info = c(
    "library location used for creating installation plan",
    "when NULL defaults to --lib-loc"
  )
)
ca$add_argument(
  "--lib-install",
  action = "list",
  default = NULL,
  info = c(
    "library location to install pkgs",
    "defaults to --lib-loc"
  )
)

args <- ca$parse()

pak_install <- function(
  pkgs,
  lib = .libPaths()[1],
  upgrade = FALSE,
  dependencies = NA,
  update = TRUE,
  sysreqs = FALSE,
  echo = FALSE,
  lib_create = lib,
  lib_install = lib
) {

  if (is.null(lib_create)) {
    lib_create <- lib
  }

  if (is.null(lib_install)) {
    lib_install <- lib
  }

  if (args$sysreqs) {
    Sys.setenv(PKG_SYSREQS = "true")
  } else {
    Sys.setenv(PKG_SYSREQS = "false")
  }

  lockfile <- tempfile()
  on.exit(unlink(lockfile), add = TRUE)

  params <- list(
    pkg = pkgs,
    lockfile = lockfile,
    lib = lib_create,
    dependencies = dependencies,
    upgrade = upgrade
  )
  writeLines(paste(c("pak::", format(do.call(call, c("lockfile_create", params)))), collapse = ""))
  do.call(pak::lockfile_create, params)

  if (echo) {
    writeLines(readLines(lockfile))
  }

  params <- list(
    lockfile = lockfile,
    lib = lib_install,
    update = update
  )
  writeLines(paste(c("pak::", format(do.call(call, c("lockfile_install", params)))), collapse = ""))
  do.call(pak::lockfile_install, params)
}

do.call(pak_install, args)
