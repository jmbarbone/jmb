#!/usr/bin/env python3

"""
A utility function for quickly looking up 
"""

import subprocess
import re
import argparse


def dbfs_log_search(
    cluster_pattern: chr = ".",
    file_pattern: chr = ".",
    single: bool = False,
    cat: bool = True
) -> None :
    """
    dbfs log search

    Description
    -----------
    Print out log files from cluster inits

    Parameters
    ----------
    cluster_pattern : str [default='.']
        A pattern to find via re.search() within the cluster directory names
    file_pattern : str [default='.']
        A pttern to find via re.search() within the cluster log file names
    single : bool [default=False]
        If True will only return the first file
    cat : bool [default=True]
        If True will print out the contents of the files
    Examples
    --------
    dbfs_log_search("npe", "r_pkgs")
    dbfs_log_search("npe", "r_pkgs", single=True)
    """
    clusters = run(["dbfs", "ls", "dbfs:/cluster-logs"])
    clusters = [cluster for cluster in clusters if re.search(cluster_pattern, cluster)]
    logs = []
    
    for cluster in clusters :
        print(f"searching in cluster: {cluster}")
        subdirs = run(["dbfs", "ls", f"dbfs:/cluster-logs/{cluster}/init_scripts"])
        subdirs.sort(reverse=True)
        subdir = subdirs[0]
        print(f"searching in subdir: {subdir}")
        files = run(["dbfs", "ls", f"dbfs:/cluster-logs/{cluster}/init_scripts/{subdir}"])
        files.sort(reverse=True)
        for file in files :
            if re.search(file_pattern, file) :
                print(f"found: {file}")
                logs.append(f"dbfs:/cluster-logs/{cluster}/init_scripts/{subdir}/{file}")
    
    logs.sort(reverse=True)
    print(f"Found: {len(logs)} files")

    if single :
        logs = logs[0:1]
        print("Showing first only")
    
    if cat :
        for log in logs :
            print("".ljust(len(log) + 4, "_"))
            print(f"\n#> {log}:")
            print("".ljust(len(log) + 4, "_") + "\n")
            subprocess.run(["dbfs", "cat", log], check=True)   
        
        print("\n".ljust(80, "_"))
    [print(log) for log in logs]
    return logs


def run(commands) :
    res = subprocess.run(commands, check=True, stdout=subprocess.PIPE)
    out = res.stdout.decode("utf-8").rsplit()
    return out


EXAMPLE_TEXT = """
examples:

    $ dbfs-logs-search npe r_pkgs
    $ dbfs-logs-search npe r_pkgs --single
    $ dbfs-logs-search npe r_pkgs --no-cat
"""

if __name__ == "__main__" :
    parser = argparse.ArgumentParser(
        description="Tries to print out the most recent log",
        epilog=EXAMPLE_TEXT,
        formatter_class=argparse.RawDescriptionHelpFormatter
    )
    parser.add_argument(
        "cluster_pattern",
        help="A pattern to match for the log directory",
        nargs="?",
        default="."
    )
    parser.add_argument(
        "file_pattern",
        help="A pattern to match for the log file",
        nargs="?",
        default="."
    )
    parser.add_argument(
        "-s", "--single",
        help="Return a single log file only",
        action=argparse.BooleanOptionalAction,
        default=False
    )
    parser.add_argument(
        "-c", "--cat",
        help="Controls pinrint for files",
        action=argparse.BooleanOptionalAction,
        default=True
    )
    args = parser.parse_args()
    dbfs_log_search(
        cluster_pattern=args.cluster_pattern,
        file_pattern=args.file_pattern,
        single=args.single,
        cat=args.cat
    )
